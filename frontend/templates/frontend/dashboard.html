{% extends 'frontend/base.html' %}
{% load static %}
{% load payments_tags %}

{% block title %}Dashboard{% endblock %}

{% block page_css %}
<style>
.dashboard-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:16px; margin-top:12px; }
.summary-card{ padding:16px; border-radius:12px; background:linear-gradient(180deg,#fff,#fbfdff); box-shadow:var(--shadow-card); }
.recent-list{ margin-top:12px; display:flex; flex-direction:column; gap:10px; }
.recent-item{ display:flex; justify-content:space-between; gap:12px; padding:10px; border-radius:8px; background:#fff; border:1px solid rgba(15,23,42,0.03); }
.quick-actions{ display:flex; gap:8px; margin-top:12px; }
.table-compact{ width:100%; border-collapse:collapse; margin-top:12px; }
.table-compact th, .table-compact td{ text-align:left; padding:8px; border-bottom:1px solid #f3f4f6; }
.chart-card{ padding:16px; background:var(--color-surface); border-radius:12px; box-shadow:var(--shadow-card); }
.chart-canvas-wrapper { width: 100%; }
/* Make canvas responsive: fill the wrapper and constrain height to avoid overstretching */
.chart-canvas-wrapper { min-height: 200px; max-height: 360px; height: 260px; }
.chart-canvas-wrapper canvas { width: 100% !important; height: 100% !important; display: block; }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div style="display:flex; justify-content:space-between; align-items:center; gap:16px; margin-top:12px;">
    <h1>Your dashboard</h1>
    <a href="{% url 'home' %}" class="btn-secondary">Back to home</a>
  </div>

  <!-- PAYMENT SECTION -->
  <div style="display:flex; gap:16px; margin-top:8px; align-items:center;">
    <h2 style="flex:1;">ðŸ’³ Payments</h2>
  </div>
  <div class="dashboard-grid">
    <div class="summary-card">
      <h3>Total spent</h3>
      <div style="font-size:20px; font-weight:700;">{{ payment_total_spent|format_kes }}</div>
      <div class="text-muted">{{ payment_total_count }} transactions</div>
    </div>

    <div class="summary-card">
      <h3>Average order</h3>
      <div style="font-size:20px; font-weight:700;">{{ payment_avg_amount|floatformat:2|format_kes }}</div>
      <div class="text-muted">Per transaction</div>
    </div>

    <div class="summary-card">
      <h3>Success rate</h3>
      <div style="font-size:20px; font-weight:700;">{{ payment_success_rate }}%</div>
      <div class="text-muted">{{ payment_success_count }} âœ“ â€¢ {{ payment_failed_count }} âœ—</div>
    </div>

    <div class="summary-card">
      <h3>Pending</h3>
      <div style="font-size:20px; font-weight:700;">{{ payment_pending_count }}</div>
      <div class="text-muted">Awaiting confirmation</div>
    </div>
  </div>

  <!-- BUY CRYPTO SECTION -->
  <div style="display:flex; gap:16px; margin-top:20px; align-items:center;">
    <h2 style="flex:1;">ðŸ’° Buy Crypto</h2>
  </div>
  <div class="dashboard-grid">
    <div class="summary-card">
      <h3>Total invested</h3>
      <div style="font-size:20px; font-weight:700;">{{ buy_total_kes|format_kes }}</div>
      <div class="text-muted">{{ buy_total_count }} buy orders</div>
    </div>

    <div class="summary-card">
      <h3>Holdings</h3>
      <div style="font-size:20px; font-weight:700;">
        {% if crypto_holdings %}
          {% for holding in crypto_holdings %}
            {% if forloop.counter == 1 %}
              {{ holding.total_held|floatformat:6 }} {{ holding.coin }}
            {% endif %}
          {% endfor %}
        {% else %}
          0.00 crypto
        {% endif %}
      </div>
      <div class="text-muted">Primary holding</div>
    </div>

    <div class="summary-card">
      <h3>Completion rate</h3>
      <div style="font-size:20px; font-weight:700;">{{ buy_completion_rate }}%</div>
      <div class="text-muted">{{ buy_completed }} âœ“ â€¢ {{ buy_pending }} pending</div>
    </div>

    <div class="summary-card">
      <h3>Total crypto</h3>
      <div style="font-size:20px; font-weight:700;">{{ buy_total_crypto|floatformat:6 }}</div>
      <div class="text-muted">Accumulated amount</div>
    </div>
  </div>

  <!-- SELL CRYPTO SECTION -->
  <div style="display:flex; gap:16px; margin-top:20px; align-items:center;">
    <h2 style="flex:1;">ðŸ’¸ Sell Crypto</h2>
  </div>
  <div class="dashboard-grid">
    <div class="summary-card">
      <h3>Total earned</h3>
      <div style="font-size:20px; font-weight:700;">{{ sell_total_kes|format_kes }}</div>
      <div class="text-muted">{{ sell_total_count }} sell orders</div>
    </div>

    <div class="summary-card">
      <h3>Total disposed</h3>
      <div style="font-size:20px; font-weight:700;">{{ sell_total_crypto|floatformat:6 }}</div>
      <div class="text-muted">Crypto sold</div>
    </div>

    <div class="summary-card">
      <h3>Completion rate</h3>
      <div style="font-size:20px; font-weight:700;">{{ sell_completion_rate }}%</div>
      <div class="text-muted">{{ sell_completed }} âœ“ â€¢ {{ sell_pending }} pending</div>
    </div>

    <div class="summary-card">
      <h3>Avg per sale</h3>
      <div style="font-size:20px; font-weight:700;">
        {% if sell_total_count > 0 %}
          {{ sell_total_kes|add:0|add:0|floatformat:0 }}
        {% else %}
          0
        {% endif %}
      </div>
      <div class="text-muted">KES per order</div>
    </div>
  </div>

  <!-- RECENT ACTIVITY SECTION -->
  <div style="margin-top:24px;">
    <h2>ðŸ“Š Recent Activity</h2>
    
    <!-- Three-column layout for Recent Payments, Recent Buys, Recent Sells -->
    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:16px; margin-top:12px;">
      
      <!-- Recent Payments -->
      <div style="padding:16px; border-radius:12px; background:var(--color-surface); box-shadow:var(--shadow-card);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <h3>ðŸ’³ Payments</h3>
          <a href="{% url 'payments:history' %}" class="btn-secondary" style="font-size:12px; padding:6px 10px;">View</a>
        </div>
        {% if recent_payments %}
          <div style="display:flex; flex-direction:column; gap:8px;">
            {% for p in recent_payments %}
              <div style="padding:10px; border-radius:8px; background:#fff; border:1px solid rgba(15,23,42,0.03);">
                <div style="display:flex; justify-content:space-between; gap:8px;">
                  <div>
                    <div style="font-weight:700; font-size:14px;">{{ p.amount|format_kes }}</div>
                    <div style="font-size:11px; color:#999;">{{ p.created_at|date:"M d" }}</div>
                  </div>
                  <div class="badge {% if p.status == 'success' %}badge-success{% elif p.status == 'pending' %}badge-pending{% else %}badge-failed{% endif %}" style="font-size:11px;">{{ p.get_status_display }}</div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted" style="font-size:13px;">No payments yet</p>
        {% endif %}
      </div>

      <!-- Recent Buys -->
      <div style="padding:16px; border-radius:12px; background:var(--color-surface); box-shadow:var(--shadow-card);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <h3>ðŸ’° Buy Orders</h3>
          <a href="{% url 'frontend:buy' %}" class="btn-primary" style="font-size:12px; padding:6px 10px;">Buy</a>
        </div>
        {% if recent_buys %}
          <div style="display:flex; flex-direction:column; gap:8px;">
            {% for trade in recent_buys %}
              <div style="padding:10px; border-radius:8px; background:#fff; border:1px solid rgba(15,23,42,0.03);">
                <div style="display:flex; justify-content:space-between; gap:8px;">
                  <div>
                    <div style="font-weight:700; font-size:14px;">{{ trade.amount_kes|format_kes }}</div>
                    <div style="font-size:11px; color:#999;">{{ trade.coin }} â€¢ {{ trade.created_at|date:"M d" }}</div>
                  </div>
                  <div class="badge {% if trade.status == 'completed' %}badge-success{% elif trade.status == 'pending' or trade.status == 'payment_confirmed' %}badge-pending{% else %}badge-failed{% endif %}" style="font-size:11px;">{{ trade.get_status_display }}</div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted" style="font-size:13px;">No buy orders yet</p>
        {% endif %}
      </div>

      <!-- Recent Sells -->
      <div style="padding:16px; border-radius:12px; background:var(--color-surface); box-shadow:var(--shadow-card);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
          <h3>ðŸ’¸ Sell Orders</h3>
          <a href="{% url 'frontend:sell' %}" class="btn-primary" style="font-size:12px; padding:6px 10px;">Sell</a>
        </div>
        {% if recent_sells %}
          <div style="display:flex; flex-direction:column; gap:8px;">
            {% for trade in recent_sells %}
              <div style="padding:10px; border-radius:8px; background:#fff; border:1px solid rgba(15,23,42,0.03);">
                <div style="display:flex; justify-content:space-between; gap:8px;">
                  <div>
                    <div style="font-weight:700; font-size:14px;">{{ trade.amount_kes|format_kes }}</div>
                    <div style="font-size:11px; color:#999;">{{ trade.coin }} â€¢ {{ trade.created_at|date:"M d" }}</div>
                  </div>
                  <div class="badge {% if trade.status == 'completed' %}badge-success{% elif trade.status == 'pending' or trade.status == 'deposit_confirmed' %}badge-pending{% else %}badge-failed{% endif %}" style="font-size:11px;">{{ trade.get_status_display }}</div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted" style="font-size:13px;">No sell orders yet</p>
        {% endif %}
      </div>

    </div>
  </div>

  <!-- CHART -->
  <div style="margin-top:24px; padding:16px; border-radius:12px; background:var(--color-surface); box-shadow:var(--shadow-card);">
    <h3>ðŸ“ˆ Last 30 days</h3>
    <div class="chart-canvas-wrapper" style="width:100%; margin-top:12px;">
      <canvas id="paymentsChart"></canvas>
    </div>
  </div>

  <div style="margin-top:20px;">
    <table class="table-compact" style="display:none;">
      <thead>
        <tr><th>ID</th><th>Amount</th><th>Phone</th><th>Status</th><th>Date</th></tr>
      </thead>
      <tbody>
        {% for p in recent_payments %}
          <tr>
            <td>#{{ p.id }}</td>
            <td>{{ p.amount|format_kes }}</td>
            <td>{{ p.phone_number }}</td>
            <td>{{ p.get_status_display }}</td>
            <td>{{ p.created_at|date:"M d, Y H:i" }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(async function(){
  try{
    const resp = await fetch('{% url "payments:history_timeseries" %}');
    const data = await resp.json();
    const ctx = document.getElementById('paymentsChart').getContext('2d');

    // function to get theme-aware palette
    function palette(isDark){
      return {
        lineColor: isDark ? 'rgba(186,147,255,1)' : '#4f46e5',
        fillColor: isDark ? 'rgba(186,147,255,0.28)' : 'rgba(79,70,229,0.12)',
        gridColor: isDark ? 'rgba(255,255,255,0.10)' : 'rgba(15,23,42,0.06)',
        tickColor: isDark ? '#dbe7ff' : '#374151',
        tooltipBg: isDark ? '#0b1220' : '#ffffff',
        tooltipTitleColor: isDark ? '#e6eef8' : '#111827',
        pointBorderColor: isDark ? '#ffffff' : '#ffffff'
      };
    }

    function createChart(ctx, data, isDark){
      const p = palette(isDark);
      return new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.labels.map(l => new Date(l).toLocaleDateString()),
          datasets: [{
            label: 'KES totals',
            data: data.totals,
            borderColor: p.lineColor,
            backgroundColor: p.fillColor,
            pointBackgroundColor: p.lineColor,
            pointBorderColor: p.pointBorderColor,
            pointRadius: 4,
            pointHoverRadius: 7,
            borderWidth: 3,
            tension: 0.24,
            fill: true
          }]
        },
        options: {
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: { color: p.tickColor },
              grid: { color: p.gridColor, lineWidth: 1 }
            },
            y: {
              beginAtZero: true,
              ticks: { color: p.tickColor },
              grid: { color: p.gridColor, lineWidth: 1 }
            }
          },
          plugins: {
            legend: { labels: { color: p.tickColor } },
            tooltip: {
              backgroundColor: p.tooltipBg,
              titleColor: p.tooltipTitleColor,
              bodyColor: isDark ? '#e6eef8' : '#111827',
              callbacks: {
                label: function(context){
                  const v = context.raw || 0;
                  return 'KES ' + Number(v).toLocaleString();
                }
              }
            }
          }
        }
      });
    }

    // create chart
    let isDarkInit = document.documentElement.getAttribute('data-theme') === 'dark';

    // Set canvas wrapper height to a sensible default so chart won't overstretch
    const wrapper = document.querySelector('.chart-canvas-wrapper');
    if(wrapper){ wrapper.style.height = '260px'; }

    let paymentsChart = createChart(ctx, data, isDarkInit);

    // Observe theme changes and update chart styles dynamically
    const observer = new MutationObserver(function(mutations){
      for(const m of mutations){
        if(m.attributeName === 'data-theme'){
          const darkNow = document.documentElement.getAttribute('data-theme') === 'dark';
          const p = palette(darkNow);
          // update dataset colors
          paymentsChart.data.datasets.forEach(ds=>{
            ds.borderColor = p.lineColor;
            ds.backgroundColor = p.fillColor;
            ds.pointBackgroundColor = p.lineColor;
            ds.pointBorderColor = p.pointBorderColor;
          });
          // update scales
          paymentsChart.options.scales.x.ticks.color = p.tickColor;
          paymentsChart.options.scales.x.grid.color = p.gridColor;
          paymentsChart.options.scales.y.ticks.color = p.tickColor;
          paymentsChart.options.scales.y.grid.color = p.gridColor;
          // legend and tooltips
          paymentsChart.options.plugins.legend.labels.color = p.tickColor;
          paymentsChart.options.plugins.tooltip.backgroundColor = p.tooltipBg;
          paymentsChart.options.plugins.tooltip.titleColor = p.tooltipTitleColor;
          paymentsChart.options.plugins.tooltip.bodyColor = darkNow ? '#e6eef8' : '#111827';

          paymentsChart.update();
        }
      }
    });
    observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });

  }catch(e){ console.error('Chart load failed', e); }
})();
</script>
{% endblock %}

{% endblock %}
