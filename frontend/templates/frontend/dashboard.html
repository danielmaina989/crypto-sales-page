{% extends 'frontend/base.html' %}
{% load static %}
{% load payments_tags %}

{% block title %}Dashboard{% endblock %}

{% block page_css %}
<style>
.dashboard-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:16px; margin-top:12px; }
.summary-card{ padding:16px; border-radius:12px; background:linear-gradient(180deg,#fff,#fbfdff); box-shadow:var(--shadow-card); }
.recent-list{ margin-top:12px; display:flex; flex-direction:column; gap:10px; }
.recent-item{ display:flex; justify-content:space-between; gap:12px; padding:10px; border-radius:8px; background:#fff; border:1px solid rgba(15,23,42,0.03); }
.quick-actions{ display:flex; gap:8px; margin-top:12px; }
.table-compact{ width:100%; border-collapse:collapse; margin-top:12px; }
.table-compact th, .table-compact td{ text-align:left; padding:8px; border-bottom:1px solid #f3f4f6; }
.chart-card{ padding:16px; background:var(--color-surface); border-radius:12px; box-shadow:var(--shadow-card); }
.chart-canvas-wrapper { width: 100%; }
/* Make canvas responsive: fill the wrapper and constrain height to avoid overstretching */
.chart-canvas-wrapper { min-height: 200px; max-height: 360px; height: 260px; }
.chart-canvas-wrapper canvas { width: 100% !important; height: 100% !important; display: block; }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div style="display:flex; justify-content:space-between; align-items:center; gap:16px; margin-top:12px;">
    <h1>Your dashboard</h1>
    <a href="{% url 'home' %}" class="btn-secondary">Back to home</a>
  </div>

  <div class="dashboard-grid">
    <div class="summary-card">
      <h3>Total spent</h3>
      <div style="font-size:20px; font-weight:700;">{{ total_spent|format_kes }}</div>
      <div class="text-muted">Over {{ total_count }} transactions</div>
    </div>

    <div class="summary-card">
      <h3>Average order</h3>
      <div style="font-size:20px; font-weight:700;">{{ avg_amount|floatformat:2|format_kes }}</div>
      <div class="text-muted">Per transaction</div>
    </div>

    <div class="summary-card">
      <h3>Success rate</h3>
      <div style="font-size:20px; font-weight:700;">{{ success_rate }}%</div>
      <div class="text-muted">{{ success_count }} succeeded • {{ failed_count }} failed</div>
    </div>

    <div class="summary-card">
      <h3>Pending</h3>
      <div style="font-size:20px; font-weight:700;">{{ pending_count }}</div>
      <div class="text-muted">Awaiting confirmation</div>
    </div>
  </div>

  <div style="display:flex; gap:16px; margin-top:18px;">
    <div style="flex:1;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>Recent payments</h2>
        <div class="quick-actions">
          <a href="{% url 'payments:history' %}" class="btn-secondary">View history</a>
          <a href="{% url 'market' %}" class="btn-primary">Buy now</a>
        </div>
      </div>

      {% if recent_payments %}
        <div class="recent-list">
          {% for p in recent_payments %}
            <div class="recent-item">
              <div>
                <div style="font-weight:700;">{{ p.amount|format_kes }}</div>
                <div class="text-muted">{{ p.created_at|date:"M d, Y H:i" }} • {{ p.phone_number }}</div>
              </div>
              <div style="text-align:right; min-width:140px;">
                <div class="badge {% if p.status == 'success' %}badge-success{% elif p.status == 'pending' %}badge-pending{% else %}badge-failed{% endif %}">{{ p.get_status_display }}</div>
                <div style="margin-top:8px;"><a href="{% url 'payments:history_detail' p.id %}" class="btn-secondary">Details</a></div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted">You have no recent payments.</p>
      {% endif %}
    </div>

    <div style="width:420px;">
      <div class="chart-card">
        <h3>Last 30 days</h3>
        <!-- Responsive canvas: size controlled by CSS to avoid overstretching -->
        <div class="chart-canvas-wrapper" style="width:100%;">
          <canvas id="paymentsChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div style="margin-top:20px;">
    <h3>Recent activity</h3>
    <table class="table-compact">
      <thead>
        <tr><th>ID</th><th>Amount</th><th>Phone</th><th>Status</th><th>Date</th></tr>
      </thead>
      <tbody>
        {% for p in recent_payments %}
          <tr>
            <td>#{{ p.id }}</td>
            <td>{{ p.amount|format_kes }}</td>
            <td>{{ p.phone_number }}</td>
            <td>{{ p.get_status_display }}</td>
            <td>{{ p.created_at|date:"M d, Y H:i" }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</div>

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(async function(){
  try{
    const resp = await fetch('{% url "payments:history_timeseries" %}');
    const data = await resp.json();
    const ctx = document.getElementById('paymentsChart').getContext('2d');

    // function to get theme-aware palette
    function palette(isDark){
      return {
        lineColor: isDark ? 'rgba(186,147,255,1)' : '#4f46e5',
        fillColor: isDark ? 'rgba(186,147,255,0.28)' : 'rgba(79,70,229,0.12)',
        gridColor: isDark ? 'rgba(255,255,255,0.10)' : 'rgba(15,23,42,0.06)',
        tickColor: isDark ? '#dbe7ff' : '#374151',
        tooltipBg: isDark ? '#0b1220' : '#ffffff',
        tooltipTitleColor: isDark ? '#e6eef8' : '#111827',
        pointBorderColor: isDark ? '#ffffff' : '#ffffff'
      };
    }

    function createChart(ctx, data, isDark){
      const p = palette(isDark);
      return new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.labels.map(l => new Date(l).toLocaleDateString()),
          datasets: [{
            label: 'KES totals',
            data: data.totals,
            borderColor: p.lineColor,
            backgroundColor: p.fillColor,
            pointBackgroundColor: p.lineColor,
            pointBorderColor: p.pointBorderColor,
            pointRadius: 4,
            pointHoverRadius: 7,
            borderWidth: 3,
            tension: 0.24,
            fill: true
          }]
        },
        options: {
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: { color: p.tickColor },
              grid: { color: p.gridColor, lineWidth: 1 }
            },
            y: {
              beginAtZero: true,
              ticks: { color: p.tickColor },
              grid: { color: p.gridColor, lineWidth: 1 }
            }
          },
          plugins: {
            legend: { labels: { color: p.tickColor } },
            tooltip: {
              backgroundColor: p.tooltipBg,
              titleColor: p.tooltipTitleColor,
              bodyColor: isDark ? '#e6eef8' : '#111827',
              callbacks: {
                label: function(context){
                  const v = context.raw || 0;
                  return 'KES ' + Number(v).toLocaleString();
                }
              }
            }
          }
        }
      });
    }

    // create chart
    let isDarkInit = document.documentElement.getAttribute('data-theme') === 'dark';

    // Set canvas wrapper height to a sensible default so chart won't overstretch
    const wrapper = document.querySelector('.chart-canvas-wrapper');
    if(wrapper){ wrapper.style.height = '260px'; }

    let paymentsChart = createChart(ctx, data, isDarkInit);

    // Observe theme changes and update chart styles dynamically
    const observer = new MutationObserver(function(mutations){
      for(const m of mutations){
        if(m.attributeName === 'data-theme'){
          const darkNow = document.documentElement.getAttribute('data-theme') === 'dark';
          const p = palette(darkNow);
          // update dataset colors
          paymentsChart.data.datasets.forEach(ds=>{
            ds.borderColor = p.lineColor;
            ds.backgroundColor = p.fillColor;
            ds.pointBackgroundColor = p.lineColor;
            ds.pointBorderColor = p.pointBorderColor;
          });
          // update scales
          paymentsChart.options.scales.x.ticks.color = p.tickColor;
          paymentsChart.options.scales.x.grid.color = p.gridColor;
          paymentsChart.options.scales.y.ticks.color = p.tickColor;
          paymentsChart.options.scales.y.grid.color = p.gridColor;
          // legend and tooltips
          paymentsChart.options.plugins.legend.labels.color = p.tickColor;
          paymentsChart.options.plugins.tooltip.backgroundColor = p.tooltipBg;
          paymentsChart.options.plugins.tooltip.titleColor = p.tooltipTitleColor;
          paymentsChart.options.plugins.tooltip.bodyColor = darkNow ? '#e6eef8' : '#111827';

          paymentsChart.update();
        }
      }
    });
    observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });

  }catch(e){ console.error('Chart load failed', e); }
})();
</script>
{% endblock %}

{% endblock %}
