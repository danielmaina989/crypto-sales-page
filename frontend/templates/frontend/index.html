{% extends 'frontend/base.html' %}
{% load static %}

{% block page_css %}
<link rel="stylesheet" href="{% static 'frontend/crypto.css' %}">
{% endblock %}

{% block title %}Cryptocurrency{% endblock %}

{% block content %}

<div class="landing">
  <div class="container">

      {% include 'frontend/components/navbar.html' %}

      <div class="content">
         <h1>BUY & <br> SELL <span>Crypto</span></h1>
         <p>World best Cryptocurrency exchange available <br> on mobile as well as mobile phone</p>
         <button class="btn-primary">EXPLORE MORE</button>
      </div>

      <div class="coin-list">
          <div class="coin" data-coin="bitcoin">
              <img src="{% static 'frontend/images/bitcoin.png' %}" alt="bitcoin">
              <div>
                  <h3>$ <span id="bitcoin"></span></h3>
                  <p>Bitcoin</p>
              </div>
          </div>

          <div class="coin" data-coin="dogecoin">
              <img src="{% static 'frontend/images/dogecoin.png' %}" alt="dogecoin">
              <div>
                  <h3>$ <span id="dogecoin"></span></h3>
                  <p>Dogecoin</p>
              </div>
          </div>

          <div class="coin" data-coin="ethereum">
              <img src="{% static 'frontend/images/ethereum.png' %}" alt="ethereum">
              <div>
                  <h3>$ <span id="ethereum"></span></h3>
                  <p>Ethereum</p>
              </div>
          </div>
      </div>

     {# include the payment modal component so the scripts can find it #}
     {% include 'frontend/components/modal_payment.html' %}

  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
(function(){
  function $(s){return document.querySelector(s)}
  function $all(s){return Array.from(document.querySelectorAll(s))}

  // Cache frequently used nodes (modal may be included via template)
  const modal = $('#payment-modal')
  const modalStatus = modal ? modal.querySelector('#modal-status') : null
  const modalPhone = modal ? modal.querySelector('#modal-phone') : null
  const modalAmount = modal ? modal.querySelector('#modal-amount') : null
  const modalPay = modal ? modal.querySelector('#modal-pay') : null
  const modalCancel = modal ? modal.querySelector('#modal-cancel') : null

  // Helper to toggle loading state on the pay button
  function setLoading(isLoading){
    if(!modalPay) return
    if(isLoading){
      modalPay.classList.add('loading')
      modalPay.disabled = true
    } else {
      modalPay.classList.remove('loading')
      modalPay.disabled = false
    }
  }

  // Helper to open/close modal (manage aria-hidden)
  function openModal(){ if(!modal) return; modal.style.display = 'flex'; modal.setAttribute('aria-hidden','false'); }
  function closeModal(){ if(!modal) return; modal.style.display = 'none'; modal.setAttribute('aria-hidden','true'); }

  let selectedCoin = null
  $all('.coin').forEach(function(el){
    el.addEventListener('click', function(){
      selectedCoin = el.getAttribute('data-coin') || 'unknown'
      if(modal){ modal.querySelector('#modal-coin').textContent = 'Buy ' + selectedCoin }
      if(modalPhone) modalPhone.value = ''
      if(modalAmount) modalAmount.value = ''
      if(modalStatus) modalStatus.textContent = ''
      openModal()
    })
  })

  if(modalCancel){ modalCancel.addEventListener('click', function(){ closeModal(); setLoading(false) }) }

  if(modalPay){
    modalPay.addEventListener('click', function(){
      const payBtn = modalPay
      const phone = modalPhone ? modalPhone.value.trim() : ''
      const amount = modalAmount ? modalAmount.value.trim() : ''
      if(!phone || !amount){ if(modalStatus) modalStatus.textContent = 'Phone and amount are required.'; return }

      // start loading
      setLoading(true)
      if(modalStatus) modalStatus.textContent = 'Initiating payment...'

      fetch('/payments/initiate/', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({phone_number: phone, amount: amount, account_ref: selectedCoin, description: selectedCoin + ' purchase'})
      }).then(function(r){
        if(!r.ok){
          return r.json().catch(function(){ throw new Error('Server error: ' + r.status) }).then(function(err){ throw new Error(err.message || err.error || 'Server error') })
        }
        return r.json()
      }).then(function(data){
        if(!data.success){
          if(modalStatus) modalStatus.textContent = 'Failed to initiate: ' + (data.message || data.error || JSON.stringify(data))
          setLoading(false)
          return
        }
        const checkout = data.checkout_request_id || data.checkoutRequestID || data.raw_response && data.raw_response.CheckoutRequestID
        if(!checkout){ if(modalStatus) modalStatus.textContent = 'No checkout id returned; contact support.'; setLoading(false); return }

        if(modalStatus) modalStatus.textContent = 'Waiting for payment confirmation...'

        // poll status
        let attempts = 0
        const maxAttempts = 40
        const poll = function(){
          attempts++
          fetch('/payments/status/' + encodeURIComponent(checkout) + '/')
            .then(r=>r.json())
            .then(function(s){
              if(s.success && s.status === 'success'){
                if(modalStatus) modalStatus.textContent = 'Payment successful! Receipt: ' + (s.receipt || '')
                setTimeout(function(){ closeModal(); setLoading(false) }, 2000)
              } else if(s.success && s.status === 'failed'){
                if(modalStatus) modalStatus.textContent = 'Payment failed: ' + (s.error || 'Unknown')
                setLoading(false)
              } else if(attempts < maxAttempts){
                setTimeout(poll, 3000)
              } else {
                if(modalStatus) modalStatus.textContent = 'Payment is taking longer than expected. Please check later.'
                setLoading(false)
              }
            }).catch(function(err){ console.error(err); if(attempts < maxAttempts) setTimeout(poll, 3000); else { if(modalStatus) modalStatus.textContent = 'Network error while checking payment. Try again later.'; setLoading(false) } })
        }
        setTimeout(poll, 2000)

      }).catch(function(err){ console.error(err); if(modalStatus) modalStatus.textContent = 'Error initiating payment: ' + (err.message || err); setLoading(false) })
    })
  }

})();
</script>
{% endblock %}
