{% extends 'frontend/base.html' %}
{% load static %}

{% block page_css %}
<link rel="stylesheet" href="{% static 'frontend/crypto.css' %}">
{% endblock %}

{% block title %}Cryptocurrency{% endblock %}

{% block content %}

<div class="landing">
  <div class="container">

      {% include 'frontend/components/navbar.html' %}

      <div class="content">
         <h1>BUY & <br> SELL <span>Crypto</span></h1>
         <p>World best Cryptocurrency exchange available <br> on mobile as well as desktop</p>
         <a href="{% url 'market' %}" class="btn-primary">Explore Market</a>
      </div>

      <h2 class="mt-6">Top Coins</h2>
      <div class="coin-list" id="top-coins">
        <!-- Top 3 coins will be populated by JS -->
      </div>

     {% include 'frontend/components/modal_payment.html' %}

  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
const topCoins = [
  {id:"bitcoin", name:"Bitcoin", symbol:"BTC", image:"{% static 'frontend/images/bitcoin.png' %}", wallet:"bitcoin:1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa"},
  {id:"ethereum", name:"Ethereum", symbol:"ETH", image:"{% static 'frontend/images/ethereum.png' %}", wallet:"ethereum:0x742d35Cc6634C0532925a3b844Bc454e4438f44e"},
  {id:"dogecoin", name:"Dogecoin", symbol:"DOGE", image:"{% static 'frontend/images/dogecoin.png' %}", wallet:"dogecoin:D8zsw1e..."}
];

async function fetchCryptoPrice(symbol){
  try {
    const res = await fetch(`https://api.coinbase.com/v2/prices/${symbol}-USD/spot`);
    const data = await res.json();
    return parseFloat(data.data.amount);
  } catch(e){ console.error('Fetch failed', symbol, e); return 0; }
}

async function fetchForexRate(){
  try {
    const res = await fetch("https://api.exchangerate.host/latest?base=USD&symbols=KES");
    const data = await res.json();
    return data?.rates?.KES || 150;
  } catch(e){ console.error('Forex fetch failed', e); return 150; }
}

async function populateTopCoins(){
  const container = document.getElementById('top-coins');
  container.innerHTML = '';
  const rate = await fetchForexRate();

  for(const coin of topCoins){
    const usd = await fetchCryptoPrice(coin.symbol);
    const kes = Math.max(1, Math.round(usd * rate));
    const div = document.createElement('div');
    div.className = 'coin';
    div.dataset.coin = coin.name;
    div.dataset.symbol = coin.symbol;
    div.dataset.wallet = coin.wallet;
    div.dataset.image = coin.image;
    div.innerHTML = `
      <img src="${coin.image}" alt="${coin.name}">
      <div>
        <h3>$ <span>${usd.toFixed(2)}</span></h3>
        <p>${coin.name}</p>
        <p>KES: ${kes.toLocaleString()}</p>
      </div>
    `;
    // trigger modal via CustomEvent so modal can handle it
    div.addEventListener('click', ()=>window.dispatchEvent(new CustomEvent('coinSelected',{detail: coin})));
    container.appendChild(div);
  }
}

populateTopCoins();
</script>
{% endblock %}
