{% extends 'frontend/base.html' %}
{% load static %}

{% block page_css %}
<link rel="stylesheet" href="{% static 'frontend/crypto.css' %}">
<style>
/* Market Grid */
.market-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
  margin-top: 24px;
}

/* Crypto Card */
.crypto-card {
  background: #ffffff;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  padding: 16px;
  transition: transform 0.2s, box-shadow 0.2s;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
}

.crypto-card h4 {
  font-size: 1.1rem;
  margin-bottom: 8px;
  color: #333;
}

.crypto-card p {
  font-size: 0.95rem;
  margin: 4px 0;
  color: #555;
}

.crypto-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.12);
}

.crypto-card img {
  width: 48px;
  height: 48px;
  margin-bottom: 12px;
}

.crypto-card .btn-buy {
  margin-top: 12px;
  padding: 6px 12px;
  border: none;
  background: #4f46e5;
  color: #fff;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s;
}

.crypto-card .btn-buy:hover {
  background: #3730a3;
}

.container > h1 {
  font-size: 2rem;
  color: #222;
}
</style>
{% endblock %}

{% block title %}Market{% endblock %}

{% block content %}
<div class="container">
  <div style="display:flex; justify-content:space-between; align-items:center; gap:16px; margin-top:12px;">
    <h1>Market</h1>
    <a href="{% url 'home' %}" class="btn-primary">Back to home</a>
  </div>
  <div id="market-grid" class="market-grid mt-4"></div>

  {% include 'frontend/components/modal_payment.html' %}
</div>
{% endblock %}

{% block scripts %}
<script>
async function fetchForexRate(){
  try {
    const res = await fetch("https://api.exchangerate.host/latest?base=USD&symbols=KES");
    const data = await res.json();
    return data?.rates?.KES || 150;
  } catch(e){ console.error('Forex fetch failed', e); return 150; }
}

// Reuse payment modal functions from modal_payment.html
const modal = document.getElementById('payment-modal');
const selName = document.getElementById('selected-coin-name');
const selImage = document.getElementById('selected-coin-image');
const selPriceUSD = document.getElementById('selected-coin-price');
const selPriceKES = document.getElementById('selected-coin-price-kes');
const walletInput = document.getElementById('wallet-address');
const qrCanvas = document.getElementById('qr-code');
const mpesaAmount = document.getElementById('mpesa-amount');

function openModal(){ modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); }

async function fetchCryptoPrice(coinId){
  try {
    const res = await fetch(`https://api.coinbase.com/v2/prices/${coinId}-USD/spot`);
    const data = await res.json();
    return parseFloat(data.data.amount);
  } catch(e){ console.error('Price fetch failed for', coinId, e); return 0; }
}

async function populateModal(coin){
  const usdPrice = await fetchCryptoPrice(coin.id);
  const rate = await fetchForexRate();
  const kesPrice = Math.max(1, Math.round(usdPrice * rate));

  selName.textContent = coin.name;
  selImage.innerHTML = coin.image ? `<img src="${coin.image}" width="60" alt="${coin.name}">` : '';
  walletInput.value = coin.wallet || '';

  selPriceUSD.textContent = usdPrice.toFixed(2);
  selPriceKES.textContent = kesPrice.toLocaleString();
  mpesaAmount.value = kesPrice;

  try{
    if(typeof QRCode!=='undefined' && qrCanvas) QRCode.toCanvas(qrCanvas, coin.wallet||'', {margin:2});
  } catch(err){ console.error('QR gen failed', err); }

  openModal();
}

async function populateMarket(){
  const grid = document.getElementById('market-grid');
  grid.innerHTML = '';
  const rate = await fetchForexRate();

  const coinsRes = await fetch("https://api.coinbase.com/v2/currencies");
  const coinsData = await coinsRes.json();
  const coins = coinsData.data.filter(c => !c.details?.type || c.details.type==='crypto');

  for(const coin of coins){
    try {
      const priceRes = await fetch(`https://api.coinbase.com/v2/prices/${coin.id}-USD/spot`);
      const priceData = await priceRes.json();
      const usd = parseFloat(priceData.data.amount);
      const kes = Math.max(1, Math.round(usd * rate));

      const div = document.createElement('div');
      div.className = 'crypto-card';
      div.innerHTML = `
        <img src="https://static.coinbase.com/icons/${coin.id}.png" alt="${coin.name}" onerror="this.style.display='none'">
        <h4>${coin.name} (${coin.id.toUpperCase()})</h4>
        <p>USD: $${usd.toFixed(2)}</p>
        <p>KES: KES ${kes.toLocaleString()}</p>
        <button class="btn-buy">Buy</button>
      `;
      grid.appendChild(div);

      div.querySelector('.btn-buy').addEventListener('click', ()=>{
        const coinData = {
          id: coin.id,
          name: coin.name,
          wallet: coin.id, // default wallet, can be updated
          image: `https://static.coinbase.com/icons/${coin.id}.png`
        };
        populateModal(coinData);
      });
    } catch(e){ console.error('Price fetch failed for', coin.id, e); }
  }
}

populateMarket();
</script>
{% endblock %}
