{% extends 'frontend/base.html' %}
{% load static %}

{% block page_css %}
<link rel="stylesheet" href="{% static 'frontend/crypto.css' %}">
<style>
/* Market Grid */
.market-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
  margin-top: 24px;
}

/* Crypto Card */
.crypto-card {
  background: #ffffff;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  padding: 16px;
  transition: transform 0.2s, box-shadow 0.2s;
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
}

.crypto-card h4 {
  font-size: 1.1rem;
  margin-bottom: 8px;
  color: #333;
}

.crypto-card p {
  font-size: 0.95rem;
  margin: 4px 0;
  color: #555;
}

.crypto-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.12);
}

.crypto-card img {
  width: 48px;
  height: 48px;
  margin-bottom: 12px;
}

.crypto-card .btn-buy {
  margin-top: 12px;
  padding: 6px 12px;
  border: none;
  background: #4f46e5;
  color: #fff;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s;
}

.crypto-card .btn-buy:hover {
  background: #3730a3;
}

/* Spinner */
.spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #4f46e5;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 0.8s linear infinite;
  margin: 24px auto;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.last-updated {
  margin-top: 12px;
  font-size: 0.9rem;
  color: #666;
  text-align: right;
}

.container > h1 {
  font-size: 2rem;
  color: #222;
}
</style>
{% endblock %}

{% block title %}Market{% endblock %}

{% block content %}
<div class="container">
  <div style="display:flex; justify-content:space-between; align-items:center; gap:16px; margin-top:12px;">
    <h1>Market</h1>
    <a href="{% url 'home' %}" class="btn-primary">Back to home</a>
  </div>
  <div id="spinner" class="spinner" style="display:none"></div>
  <div id="market-grid" class="market-grid mt-4"></div>
  <div class="last-updated" id="last-updated"></div>

  {% include 'frontend/components/modal_payment.html' %}
</div>
{% endblock %}

{% block scripts %}
<script>
async function fetchCachedRates() {
    try {
        const res = await fetch('/api/market-prices/');
        if(!res.ok) throw new Error('server error: ' + res.status);
        return await res.json();
    } catch(e){ console.error('Server fetch failed', e); return {coins: [], rate: 150}; }
}

function openModal(){ const modal = document.getElementById('payment-modal'); modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); }

async function populateModal(coin){
    const selName = document.getElementById('selected-coin-name');
    const selImage = document.getElementById('selected-coin-image');
    const selPriceUSD = document.getElementById('selected-coin-price');
    const selPriceKES = document.getElementById('selected-coin-price-kes');
    const walletInput = document.getElementById('wallet-address');
    const qrCanvas = document.getElementById('qr-code');
    const mpesaAmount = document.getElementById('mpesa-amount');

    selName.textContent = coin.name;
    selImage.innerHTML = coin.image ? `<img src="${coin.image}" width="60" alt="${coin.name}">` : '';
    walletInput.value = coin.wallet || '';
    selPriceUSD.textContent = coin.usd.toFixed(2);
    selPriceKES.textContent = coin.kes.toLocaleString();
    mpesaAmount.value = coin.kes;

    try{ if(typeof QRCode!=='undefined' && qrCanvas) QRCode.toCanvas(qrCanvas, coin.wallet||'', {margin:2}); } catch(err){ console.error('QR gen failed', err); }

    openModal();
}

async function populateMarket(){
    const grid = document.getElementById('market-grid');
    const spinner = document.getElementById('spinner');
    const lastUpdatedEl = document.getElementById('last-updated');

    spinner.style.display = 'block';
    grid.innerHTML = '';
    lastUpdatedEl.textContent = '';

    const data = await fetchCachedRates();
    const coins = data.coins || [];
    const rate = data.rate || 150;

    coins.forEach(coin => {
        const div = document.createElement('div');
        div.className = 'crypto-card';
        div.innerHTML = `
            <img src="${coin.image}" alt="${coin.name}" onerror="this.style.display='none'">
            <h4>${coin.name} (${coin.id.toUpperCase()})</h4>
            <p>USD: $${coin.usd.toFixed(2)}</p>
            <p>KES: KES ${coin.kes.toLocaleString()}</p>
            <button class="btn-buy">Buy</button>
        `;
        grid.appendChild(div);

        div.querySelector('.btn-buy').addEventListener('click', ()=>{ populateModal(coin); });
    });

    spinner.style.display = 'none';
    lastUpdatedEl.textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
}

populateMarket();
</script>
{% endblock %}
