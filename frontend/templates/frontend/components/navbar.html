{% load static %}
<nav class="site-nav" role="navigation" aria-label="Main navigation">
  <div class="site-nav__inner container">
    <a class="site-nav__brand" href="{% url 'market' %}" title="View market">
      <img src="{% static 'frontend/images/logo.png' %}" alt="Logo" class="site-nav__logo logo-light">
      <!-- Optional dark-mode logo: put a dark variant at frontend/images/logo-dark.png to show in dark theme -->
      <img src="{% static 'frontend/images/logo-dark.png' %}" alt="Logo" class="site-nav__logo logo-dark" style="display:none">
      <!-- Text fallback: shown by default, hidden when a working logo image is available -->
      <span class="site-nav__brand-text" style="display:inline-block; font-weight:700; margin-left:8px;">Crypto Sales Page</span>
    </a>

    <button class="site-nav__toggle" aria-expanded="false" aria-controls="site-nav-links" aria-label="Toggle navigation">
      <span class="hamburger"></span>
    </button>

    <ul id="site-nav-links" class="site-nav__links">
      <li><a href="{% url 'market' %}" title="Explore market">Market</a></li>
      <li><a href="{% url 'features' %}" title="See features">Features</a></li>
      <li><a href="{% url 'whitepapers' %}" title="Read whitepapers">Whitepapers</a></li>
      <li><a href="{% url 'about' %}" title="About us">About Us</a></li>
    </ul>

    <div class="site-nav__actions">
      <!-- Universal CTA to buy quickly; if modal present it will open, otherwise go to market -->
      <button id="nav-buy-now" class="btn-primary" title="Buy crypto now" aria-label="Buy crypto now">Buy crypto now</button>

      {% if user.is_authenticated %}
        <a href="{% url 'dashboard' %}" class="btn-secondary" title="Open your dashboard" aria-label="Dashboard">Dashboard</a>

        <form method="post" action="{% url 'logout' %}" style="display:inline; margin:0;">
          {% csrf_token %}
          <button type="submit" class="btn-secondary" title="Log out" aria-label="Log out">Log out</button>
        </form>

      {% else %}
        <a href="{% url 'login' %}" class="btn-secondary" title="Log in to your account" aria-label="Log in">Log in</a>
        <a href="{% url 'register' %}" class="btn-primary" title="Create an account" aria-label="Sign up">Get started</a>
      {% endif %}

      <!-- Theme toggle (basic client-side toggle) - aria-pressed managed by JS -->
      <button id="theme-toggle" class="btn-secondary" title="Toggle theme" aria-label="Toggle light or dark theme" aria-pressed="false">Theme</button>
    </div>
  </div>
</nav>

<script>
  // Small inline toggle script for the navbar (keeps component self-contained)
  (function(){
    var btn = document.querySelector('.site-nav__toggle');
    var nav = document.querySelector('.site-nav');
    var links = document.getElementById('site-nav-links');
    if(!btn || !nav || !links) return;
    btn.addEventListener('click', function(){
      var expanded = btn.getAttribute('aria-expanded') === 'true';
      btn.setAttribute('aria-expanded', String(!expanded));
      nav.classList.toggle('open');
    });

    // Buy button: try to open the payment modal if present, otherwise go to market
    var buyBtn = document.getElementById('nav-buy-now');
    if(buyBtn){
      buyBtn.addEventListener('click', function(e){
        // Try to find the demo open button (modal component)
        var demo = document.getElementById('open-payment-demo');
        if(demo){
          demo.click();
          // close nav on mobile if open
          btn.setAttribute('aria-expanded', 'false');
          nav.classList.remove('open');
          return;
        }
        // fallback: redirect to market page
        window.location.href = '{% url "market" %}';
      });
    }

    // Theme toggle: simple client-side toggle (stores preference in localStorage)
    var themeToggle = document.getElementById('theme-toggle');
    if(themeToggle){
      // Check whether a dark-logo file actually exists (avoid showing broken img)
      var logoLight = document.querySelector('.logo-light');
      var logoDark = document.querySelector('.logo-dark');
      var hasDarkLogo = false;
      if(logoDark && logoDark.getAttribute('src')){
        try{
          var probe = new Image();
          probe.onload = function(){
            hasDarkLogo = true;
            // If theme is already dark, swap logos now
            try{
              var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
              if(isDark && logoLight && logoDark){
                logoLight.style.display = 'none';
                logoDark.style.display = '';
                logoLight.classList.remove('logo-dark-fallback-filter');
              }
            }catch(e){}
          };
          probe.onerror = function(){
            hasDarkLogo = false;
            // If dark theme active and dark logo missing, ensure fallback filter is applied
            try{
              if(document.documentElement.getAttribute('data-theme') === 'dark' && logoLight){
                logoLight.classList.add('logo-dark-fallback-filter');
                if(logoDark) logoDark.style.display = 'none';
              }
            }catch(e){}
          };
           probe.src = logoDark.getAttribute('src');
         }catch(e){ hasDarkLogo = false; }
       }

      // helper: show textual brand if no usable logo images are available
      var brandText = document.querySelector('.site-nav__brand-text');
      function hideBrandText(){ if(brandText) brandText.style.display = 'none'; }
      function showBrandText(){ if(brandText) brandText.style.display = ''; }

      // If a light logo loads successfully, hide the brand text immediately
      if(logoLight){
        if(logoLight.complete && logoLight.naturalWidth && logoLight.naturalWidth>0){ hideBrandText(); }
        logoLight.addEventListener('load', function(){ hideBrandText(); });
        logoLight.addEventListener('error', function(){ /* keep text visible */ });
      }

      // If a dark logo loads successfully and we decide to show it, hide the brand text
      if(logoDark){
        if(logoDark.complete && logoDark.naturalWidth && logoDark.naturalWidth>0){ hideBrandText(); }
        logoDark.addEventListener('load', function(){ hideBrandText(); });
        logoDark.addEventListener('error', function(){ /* keep text visible */ });
      }

      // Also, when probe determines dark logo availability, re-evaluate visibility
      var evaluateVisibilityAfterProbe = function(){
        var lightOk = logoLight && logoLight.complete && logoLight.naturalWidth && logoLight.naturalWidth>0;
        var darkOk = logoDark && logoDark.complete && logoDark.naturalWidth && logoDark.naturalWidth>0 && hasDarkLogo;
        if(!lightOk && !darkOk){ showBrandText(); }
        else { hideBrandText(); }
      };
      setTimeout(evaluateVisibilityAfterProbe, 100);

      var applyTheme = function(theme){
        if(theme === 'dark'){
          document.documentElement.setAttribute('data-theme', 'dark');
          themeToggle.setAttribute('aria-pressed', 'true');
          themeToggle.textContent = 'Light';
          themeToggle.title = 'Switch to light theme';
          // If a real dark logo exists, show it; otherwise keep light logo and apply a readable filter
          if(hasDarkLogo && logoLight && logoDark){
            logoLight.style.display = 'none';
            logoDark.style.display = '';
            logoLight.classList.remove('logo-dark-fallback-filter');
          } else if(logoLight){
            // fallback: visually adapt the single logo for dark backgrounds
            logoLight.style.display = '';
            logoLight.classList.add('logo-dark-fallback-filter');
            if(logoDark) logoDark.style.display = 'none';
          }
        } else {
          document.documentElement.removeAttribute('data-theme');
          themeToggle.setAttribute('aria-pressed', 'false');
          themeToggle.textContent = 'Dark';
          themeToggle.title = 'Switch to dark theme';
          if(logoLight){ logoLight.style.display = ''; logoLight.classList.remove('logo-dark-fallback-filter'); }
          if(logoDark) logoDark.style.display = 'none';
        }
      };

      // Determine initial theme: saved > prefers-color-scheme > light
      try{
        var saved = null;
        try { saved = localStorage.getItem('site-theme'); } catch(e) { saved = null; }
        if(saved === 'dark' || saved === 'light'){
          applyTheme(saved);
        } else if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches){
          applyTheme('dark');
        } else {
          applyTheme('light');
        }
      }catch(e){ console.warn('theme init failed', e); applyTheme('light'); }

      themeToggle.addEventListener('click', function(){
        try{
          var current = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
          var next = current === 'dark' ? 'light' : 'dark';
          applyTheme(next);
          try { localStorage.setItem('site-theme', next); } catch(e){}
        }catch(e){ console.error(e); }
      });
    }

  })();
</script>
